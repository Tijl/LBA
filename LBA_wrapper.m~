% LBA_wrapper
%
% Example script for nesting LBA model fitting and graphical output
%
% Uses exampledata from Donkin et al. (2009)
%
% Here we compare the fit of two models - model 1 allows drift rate to vary
% between conditions and fixes all other parameters; model 2 allows bound
% to vary between conditions and fixes all other parameters
%
% As the data were generated by conditions of different difficulty, model 1
% is a priori the most plausible
%
% SF 2012

clear all
close all

load exampledata.mat
models = 2;

%% Clean up data
data = LBA_clean(data);

%% Setup models (see help LBA_mle)
model(1).v = 3; model(1).A = 1; model(1).b = 1; model(1).t0 = 1; model(1).sv = 1;
model(2).v = 1; model(2).A = 1; model(2).b = 3; model(2).t0 = 1; model(2).sv = 1;
pArray{1} = [0.8 0.8 0.8 300 150 200 0.4];
pArray{2} = [0.8 300 300 300 150 200 0.4];
names{1} = ['v1 \t v2 \t v3 \t A \t B \t t0 \t sv'];
names{2} = ['v \t A \t b1 \t b2 \t b3 \t t0 \t sv'];

for m = 1:models
    [params{m} LL(m)] = LBA_mle(data, model(m), pArray{m});
end

%% Compare plots of data and model fit
for m = 1:models
    
    Ncond = max(data.cond);
    cor = data.response == data.stim;
    [v A b t0 sv] = LBA_parse(model(m), params{m}, Ncond);
    
    nbin = 10;
    minRT = 100;
    maxRT = 1000;
    bins = linspace(minRT, maxRT, nbin);
    bindiff = bins(3)-bins(2);
    
    figure;
    set(gcf,'Position',[150 500 450.*Ncond 250]);
    for j = 1:Ncond
        subplot(1,Ncond,j);
        
        % corrects
        histdata = hist(data.rt(cor & data.cond == j), bins);
        vi = [v(j) 1-v(j)];
        histpred = LBA_n1PDF(bins-t0(j),A(j),b(j)+A(j),vi,sv(j));
        % histpred is likelihood of a single trial at this RT
        % need to scale to area of bar (bindiff*trials)
        histpred = histpred.*bindiff.*sum(data.cond == j);
        h = bar(bins, histdata);
        set(h, 'edgecolor','b','LineWidth',2,'facecolor','w');
        hold on
        plot(bins, histpred, 'b','LineWidth',2);
        
        % errors
        histdata = hist(data.rt(~cor & data.cond == j), bins);
        vi = [1-v(j) v(j)];
        histpred = LBA_n1PDF(bins-t0(j),A(j),b(j)+A(j),vi,sv(j));
        % histpred is likelihood of a single trial at this RT
        % need to scale to area of bar (bindiff*trials)
        histpred = histpred.*bindiff.*sum(data.cond == j);
        h = bar(bins+(bindiff/2), histdata);
        set(h, 'edgecolor','r','LineWidth',2,'facecolor','w');
        hold on
        plot(bins+(bindiff/2), histpred, 'r','LineWidth',2);
        xlabel('RT');
        ylabel('Freq');
        
    end
    
    fprintf('\n\n Model %d parameters: \n\n',m);
    fprintf(['\n\n' names{m} '\n\n']);
    fprintf(num2str(params));
end